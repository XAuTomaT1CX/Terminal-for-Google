<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8"/>
	<link rel="stylesheet" type="text/css" href="css/pop.css">
</head>
<body>
	<div id="link-list">
		<a href="#" id="status-link" class="link">Apps Dashboard</a>
		<a href="#" id="option-link" class="link">Option Page</a>
	</div>
	<script type="text/javascript">
		var backgroundPage = chrome.extension.getBackgroundPage();
		var pref = backgroundPage.pref,
			badge = backgroundPage.badge;
		
		window.addEventListener('pref-changed', function(e){
			if(e.key === 'icon-only'){
				if(e.value){
					document.body.classList.add('icon-only');
				}else{
					document.body.classList.remove('icon-only');
				}
			}else if(e.key === 'columns'){
				document.body.classList.remove('columns-3');
				document.body.classList.remove('columns-4');
				document.body.classList.remove('columns-5');
				document.body.classList.add('columns-' + e.value);
			}else{
				location.reload();
			}
		});
		
		window.addEventListener('badge-changed', function(){
			setBadge();
		});
		
		function $id(id, callback){
			var node = document.getElementById(id);
			if(node && callback){
				callback(node);
			}
			return node;
		}
		
		var columns = pref.get('columns');
		document.body.classList.add('columns-' + columns);
		
		var showIconOnly = pref.get('icon-only');
		if(showIconOnly){
			document.body.classList.add('icon-only');
		}
		
		var linkList = $id("link-list");
		
		// サービスのアイコンを作成してbodyに追加
		var createIcon = function(service){
			var node = document.createElement('a');
			node.classList.add('icon');
			node.href = '#';
			node.addEventListener('click', function(e){
				service.open();
				window.close();
				e.preventDefault();
			}, false);
			
			var icon = document.createElement('img');
			icon.src = service.icon;
			node.appendChild(icon);
			
			var caption = document.createElement('span');
			caption.textContent = service.name;
			node.appendChild(caption);
			
			var badge = document.createElement('button');
			badge.id =  service.id + '-badge';
			node.appendChild(badge);
			
			document.body.insertBefore(node, linkList);
			return node;
		};
		
		var services = {};
		var serviceIds = backgroundPage.services.filter(function(service){
			return service.isEnabled;
		}).map(function(service){
			services[service.id] = service;
			return service.id;
		});
		
		// 順番にしたがってサービスのアイコンを作成
		pref.get('service-order', []).forEach(function(id){
			var service;
			if(id in services){
				service = services[id];
				createIcon(service);
				serviceIds.splice(serviceIds.indexOf(id), 1);
			}
		});
		
		serviceIds.forEach(function(id){
			var service = services[id];
			createIcon(service);
		});
		
		// リンクの動作を設定
		$id("status-link").addEventListener('click', function(e){
			chrome.tabs.create({
				url: "http://www.google.com/appsstatus",
				selected: true
			});
			window.close();
		});
		
		$id("option-link").addEventListener('click', function(e){
			chrome.tabs.create({
				url: chrome.extension.getURL("/views/option.html"),
				selected: true
			});
			window.close();
		});
		
		// バッジの内容を設定
		function setBadge(){
			$id('gmail-badge', function(gmailBadge){
				if(showIconOnly && parseInt(badge.gmail) > 99){
					gmailBadge.textContent = '!';
				}else{
					gmailBadge.textContent = badge.gmail || '';
				}
			});
			
			$id('reader-badge', function(readerBadge){
				if(showIconOnly && parseInt(badge.reader) > 99){
					readerBadge.textContent = '!';
				}else{
					readerBadge.textContent = badge.reader || '';
				}
			});
		}
		
		setBadge();
		
		$id('appengine-badge', function(gae){
			gae.textContent = showIconOnly? '?': 'Status';
			gae.addEventListener('click', function(e){
				var url = (pref.get('secure')? 'https://': 'http://') +
					"code.google.com/status/appengine";
				chrome.tabs.create({url: url, selected: true});
				window.close();
				e.stopPropagation();
			}, false);
		});

		$id('urlshortener-badge', function(badge){
			badge.textContent = showIconOnly? '+': 'Shorten';
			badge.addEventListener('click', function(e){
				e.stopPropagation();
				chrome.tabs.getSelected(null, function(tab){
					chrome.tabs.create({
						url: 'http://goo.gl',
						selected: true
					}, function(newTab){
						chrome.tabs.executeScript(newTab.id, {
							code: 'document.querySelector("#shorten")' +
								'.value ="' + tab.url + '";'
						});
						close();
					});
				});
			});
		});
	</script>
</body>
</html>
