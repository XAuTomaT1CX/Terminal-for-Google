<!DOCTYPE HTML>
<html lang="ja">
<head>
	<meta charset="UTF-8">
	<title>Terminal for Google</title>
	<link rel="stylesheet" type="text/css" href="css/opt.css" media="all">
	<script type="text/javascript" src="js/pref.js"></script>
</head>
<body>
	<header>
		<h1>
			<img src="image/goog-logo-old.png" width="64" height="64" />
			<span>Options</span>
		</h1>
		<ul>
			<li><a href="#policy">Policy</a></li>
			<li><a href="#service">Service</a></li>
			<li><a href="#about">About</a></li>
		</ul>
	</header>
	
	<section id="policy">
		<section>
			<h2>Security</h2>
			<label for="secure-box">
				<input type="checkbox" name="secure-box" id="secure-box" />
				<span>use HTTPS</span>
				<span class="msg"></span>
			</label>
		</section>
		<section>
			<h2>Appearance</h2>
			<label for="icon-only-box">
				<input type="checkbox" name="icon-only-box" id="icon-only-box" />
				<span>show icon only</span>
				<span class="msg"></span>
			</label>
			<label for="columns-box">
				<span>columns</span>
				<select name="columns-box" id="columns-box">
					<option value="3">3</option>
					<option value="4">4</option>
					<option value="5">5</option>
				</select>
				<span class="msg"></span>
			</label>
		</section>
	</section>
	
	<section id="service">
		<section>
			<h2>Enabled Services</h2>
			<ul id="enabled-service-list"></ul>
		</section>
		<section>
			<h2>Disabled Services</h2>
			<ul id="disabled-service-list"></ul>
		</section>
	</section>
	
	<section id="about">
		<p>
			<a href="https://github.com/Chick307/Google-Terminal" target="_blank">
				<em>Terminal for Google</em>
			</a> is created by
			<a href="http://twitter.com/chick307" target="_blank">@chick307</a>.
		</p>
		<p>
			All icons this extension uses are created by 
			<a href="http://tempest.deviantart.com/art/Simply-Google-II-Part-I-192918636" target="_blank">
				tempest</a>.
		</p>
	</section>
	
	<script type="text/javascript">
		var backgroundPage = chrome.extension.getBackgroundPage();
		var pref = backgroundPage.pref,
			services = backgroundPage.services;
		
		// ページを開いたとき、ページ内リンクで移動したとき
		window.addEventListener('popstate', function(){
			var e;
			
			if(e = document.querySelector('li.target')){
				e.classList.remove('target');
			}
			
			if(e = document.querySelector('a[href$=\\' + location.hash + ']')){
				e.parentNode.classList.add('target');
			}
		}, false);
		
		if(!location.hash){
			history.replaceState('', '', 'opt.html#policy');
		}
		
		var listeners = {};
		window.addEventListener('pref-changed', function(e){
			if(e.key in listeners){
				listeners[e.key].call(null, e);
			}
		});
		
		
		var createOnSavedFunc = function(node){
			var label = node.parentNode;
			var timeout;
			
			return function(){
				var self = arguments.callee;
				if(timeout){
					clearTimeout(timeout);
					label.classList.remove('changed');
					timeout = setTimeout(function(){
						timeout = null;
						self();
					}, 500);
					return;
				}
				
				label.classList.add('changed');
				timeout = setTimeout(function(){
					label.classList.remove('changed');
					timout = null;
				}, 3000);
			};
		};
		
		
		// HTTPSにするかどうかの設定項目
		var secureBox = document.getElementById("secure-box");
		var onSecureSaved = createOnSavedFunc(secureBox);
		secureBox.checked = pref.get('secure', true);
		secureBox.addEventListener("change", function(){
			pref.set('secure', this.checked);
			onSecureSaved();
		}, false);
		listeners['secure'] = function(e){
			if(secureBox.checked !== e.value){
				secureBox.checked = e.value;
				onSecureSaved();
			}
		};
		
		
		// アイコンだけ表示するかどうかの設定項目
		var iconOnlyBox = document.getElementById('icon-only-box');
		var onIconOnlySaved = createOnSavedFunc(iconOnlyBox);
		iconOnlyBox.checked = pref.get('icon-only', false);
		iconOnlyBox.addEventListener("change", function(){
			pref.set('icon-only', this.checked);
			onIconOnlySaved();
		}, false);
		listeners['icon-only'] = function(e){
			if(iconOnlyBox.checked !== e.value){
				iconOnlyBox.checked = e.value;
				onIconOnlySaved();
			}
		};
		
		// アイコンの列の数
		var columns = pref.get('columns', 3);
		var columnsBox = document.getElementById('columns-box');
		var onColumnsSaved = createOnSavedFunc(columnsBox);
		columnsBox.value = columns;
		columnsBox.addEventListener("change", function(){
			pref.set('columns', this.value);
			onColumnsSaved();
		}, false);
		listeners['columns'] = function(e){
			if(columnsBox.value !== e.value){
				columnsBox.value = e.value;
				onColumnsSaved();
			}
		};
		
		
		// サービスのアイコンを作成
		var createIcon = function(service){
			var node = document.createElement('a');
			node.id = service.id;
			node.classList.add('service-item');
			node.href = '#';
			node.addEventListener('click', function(e){
				e.preventDefault();
			}, false);
			node.addEventListener('dragstart', function(e){
				e.dataTransfer.setData('Text', service.id);
				document.body.classList.add('dragging');
			}, false);
			
			var icon = document.createElement('img');
			icon.src = service.icon;
			node.appendChild(icon);
			
			var caption = document.createElement('span');
			caption.textContent = service.name;
			node.appendChild(caption);
			
			return node;
		};
		
		
		var enabledServices = {},
			disabledServices = {},
			services = {};
		var serviceIds = backgroundPage.services.map(function(service){
			services[service.id] = service;
			return service.id;
		});
		
		
		var preventDefault = function(e){ e.preventDefault(); };
		
		var enabledServiceList = document.getElementById("enabled-service-list");
		
		enabledServiceList.addEventListener('dragover', preventDefault, false);
		enabledServiceList.addEventListener('dragenter', preventDefault, false);
		enabledServiceList.addEventListener('drop', function(e){
			e.preventDefault();
			
			document.body.classList.remove('dragging');
			
			var id = event.dataTransfer.getData('Text');
			var node = document.getElementById(id);
			
			var target = e.target;
			while(!target.classList.contains('service-item') && target !== this){
				target = target.parentNode;
			}
			
			if(target === node){
				return;
			}else if(target === this){
				this.appendChild(node);
			}else if(node.parentNode === this){
				var children = Array.prototype.slice.call(this.children);
				if(children.indexOf(node) < children.indexOf(target)){
					if(target.nextSibling){
						this.insertBefore(node, target.nextSibling);
					}else{
						this.appendChild(node);
					}
				}else{
					this.insertBefore(node, target);
				}
			}else{
				this.insertBefore(node, target);
			}
			
			// Disabled Servicesからドラッグしてきた場合
			if(id in disabledServices){
				enabledServices[id] = disabledServices[id];
				delete disabledServices[id];
				enabledServices[id].enable();
			}
			
			saveServiceOrder();
		}, false);
		
		var disabledServiceList = document.getElementById("disabled-service-list");
		
		disabledServiceList.addEventListener('dragover', preventDefault, false);
		disabledServiceList.addEventListener('dragenter', preventDefault, false);
		disabledServiceList.addEventListener('drop', function(e){
			e.preventDefault();
			
			document.body.classList.remove('dragging');
			
			var id = event.dataTransfer.getData('Text');
			var node = document.getElementById(id);
			
			var target = e.target;
			while(!target.classList.contains('service-item') && target !== this){
				target = target.parentNode;
			}
			
			if(target === node){
				return;
			}else if(target === this){
				this.appendChild(node);
			}else if(node.parentNode === this){
				var children = Array.prototype.slice.call(this.children);
				if(children.indexOf(node) < children.indexOf(target)){
					if(target.nextSibling){
						this.insertBefore(node, target.nextSibling);
					}else{
						this.appendChild(node);
					}
				}else{
					this.insertBefore(node, target);
				}
			}else{
				this.insertBefore(node, target);
			}
			
			// Enabled Servicesからドラッグしてきた場合
			if(id in enabledServices){
				disabledServices[id] = enabledServices[id];
				delete enabledServices[id];
				disabledServices[id].disable();
			}
			
			saveServiceOrder();
		}, false);
		
		
		enabledServiceList.parentNode.classList.add('columns-' + columns);
		listeners['columns'] = (function(orig){
			return function(e){
				orig(e);
				enabledServiceList.parentNode.classList.remove('columns-3');
				enabledServiceList.parentNode.classList.remove('columns-4');
				enabledServiceList.parentNode.classList.remove('columns-5');
				enabledServiceList.parentNode.classList.add('columns-' + e.value);
			};
		})(listeners['columns']);
		
		
		// 順番にしたがってサービスのアイコンを作成
		pref.get('service-order', []).forEach(function(id){
			var service = services[id],
				icon = createIcon(service);
			
			if(service.isEnabled){
				enabledServices[id] = service;
				serviceIds.splice(serviceIds.indexOf(id), 1);
				enabledServiceList.appendChild(icon);
			}else{
				disabledServices[id] = service;
				serviceIds.splice(serviceIds.indexOf(id), 1);
				disabledServiceList.appendChild(icon);
			}
			
			listeners[id + '-enabled'] = function(e){
				if(e.value){
					if(id in disabledServices){
						enabledServices[id] = service;
						delete disabledServices[id];
						enabledServiceList.appendChild(icon);
					}
				}else{
					if(id in enabledServices){
						disabledServices[id] = service;
						delete enabledServices[id];
						disabledServiceList.appendChild(icon);
					}
				}
			};
		});
		
		listeners['service-order'] = function(e){
			var order = e.value.slice(), enabled = null, disabled = null, e;
			order.reverse().forEach(function(id){
				e = document.getElementById(id)
				if(id in enabledServices){
					if(enabled != null && enabled.previousSibling !== e){
						enabledServiceList.insertBefore(e, enabled);
					}
					
					enabled = e;
				}else{
					if(disabled != null && disabled.previousSibling !== e){
						disabledServiceList.insertBefore(e, disabled);
					}
					
					disabled = e;
				}
			});
		};
		
		serviceIds.forEach(function(id){
			var service = services[id];
			if(service.isEnabled){
				enabledServices[id] = service;
				enabledServiceList.appendChild(createIcon(service));
			}else{
				disabledServices[id] = service;
				disabledServiceList.appendChild(createIcon(service));
			}
		});
		
		// サービスの順番を保存する
		function saveServiceOrder(){
			var e = Array.prototype.slice.call(enabledServiceList.children),
				d = Array.prototype.slice.call(disabledServiceList.children);
			var children = e.concat(d);
			var order = children.map(function(child){
				return child.id;
			});
			
			pref.set('service-order', order);
		}
	</script>
</body>
</html>