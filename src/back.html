<!DOCTYPE html>
<html>
<head>

<meta charset="utf-8"/>
<script src="js/http.js"></script>
<script src="js/service.js"></script>
<script src="js/pref.js"></script>
<script>
	var pref = new Preference({prefix: 'pref-'});
	pref.onChange.addListener(function(key, value){
		var e = document.createEvent('Event');
		e.initEvent('pref-changed', false, false);
		e.key = key;
		e.value = value;
		chrome.extension.getViews().forEach(function(view){
			view.dispatchEvent(e);
		});
	});
	
	var badge = {
		_gmail: null,
		_reader: null,
		setColor: function(r, g, b, a){
			chrome.browserAction.setBadgeBackgroundColor({
				color: [
					Math.min(r, 255),
					Math.min(g, 255),
					Math.min(b, 255),
					Math.min(a, 255)
				]
			});
		},
		setText: function(text){
			chrome.browserAction.setBadgeText({text: text || ''});
		},
		refresh: function(){
			var r = 0, g = 0, b = 0, text = null;
			
			if(this._gmail){
				r += 208;
				b += 24;
				text = this._gmail;
			}
			
			if(this._reader){
				g += 24;
				b += 208;
				text = text? '!': this._reader;
			}
			
			this.setColor(r, g, b, 255);
			this.setText(text);
		},
		get gmail(){
			return this._gmail;
		},
		set gmail(value){
			this._gmail = (value == 0 || value == null)? null: String(value);
			this.refresh();
		},
		get reader(){
			return this._reader;
		},
		set reader(value){
			this._reader = (value == 0 || value == null)? null: String(value);
			this.refresh();
		}
	};
	
	// 古い設定の引き継ぎ
	localStorage.pref && (function(str){
		try{
			var json = JSON.parse(str);
			
			if(json.secure != null){
				pref.setDefault('secure', json.secure);
			}
			
			serviceInfo.forEach(function(service){
				var key = serviceInfo.id + '-enabled';
				if(json[key] != null){
					pref.setDefault(key, json[key]);
				}
			});
		}catch(e){
			console.error(e);
		}
		
		localStorage.removeItem('pref');
	})(localStorage.pref);
	
	initialize();
</script>

</head>
<body></body>
</html>