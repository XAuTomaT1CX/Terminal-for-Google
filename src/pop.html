<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8"/>
	<link rel="stylesheet" type="text/css" href="css/pop.css">
</head>
<body>
	<a href="#" id="icon-template" class="icon">
		<div class="icon-content">
			<span class="icon-name"></span>
			<br />
			<button></button>
		</div>
	</a>
	<div id="link-list">
		<a href="#" id="status-link" class="link">Google Apps Status</a><br />
		<a href="#" id="option-link" class="link">Option Page</a>
	</div>
	<script type="text/javascript">
		var backgroundPage = chrome.extension.getBackgroundPage();
		var pref = backgroundPage.pref,
			badge = backgroundPage.badge;
		
		function $id(id, callback){
			var node = document.getElementById(id);
			if(node && callback){
				callback(node);
			}
			return node;
		}
		
		var template = $id('icon-template');
		var clone = function(){
			var node = template.cloneNode(true);
			return {
				node: node,
				content: node.querySelector('div'),
				name: node.querySelector('span'),
				badge: node.querySelector('button')
			};
		};
		
		backgroundPage.services.forEach(function(service){
			if(service.isEnabled){
				var icon = clone();
				
				icon.node.id = service.id + '-icon';
				icon.node.addEventListener('click', function(e){
					service.open();
				}, false);
				icon.content.style.backgroundImage = 'url(' + service.icon + ')';
				icon.name.textContent = service.name;
				icon.badge.id = service.id + '-badge';
				document.body.appendChild(icon.node);
			}
		});
		
		document.body.appendChild($id("link-list"));
		document.body.appendChild(document.createElement('br'));
		
		$id("status-link").addEventListener('click', function(e){
			chrome.tabs.create({
				url: "http://www.google.com/appsstatus",
				selected: true
			});
		});
		
		$id("option-link").addEventListener('click', function(e){
			chrome.tabs.create({
				url: chrome.extension.getURL("opt.html"),
				selected: true
			});
		});
		
		$id('gmail-badge', function(gmailBadge){
			gmailBadge.textContent = badge.gmail || '';
		});
		
		$id('reader-badge', function(readerBadge){
			readerBadge.textContent = badge.reader || '';
		});
		
		$id('appengine-badge', function(gae){
			gae.textContent = 'Status';
			gae.addEventListener('click', function(e){
				var url = (pref.get('secure', true)? 'https://': 'http://') +
					"code.google.com/status/appengine";
				chrome.tabs.create({url: url, selected: true});
				e.stopPropagation();
			}, false);
		});
	</script>
</body>
</html>